\section{Installation Instructions for Mistral}%
\label{installation-instructions-for-mistral}

Mistral (HLRE-3) is the supercomputer installed at DKRZ in 2015/2016.
This guide documents installation procedures to build prerequisites as
well as the prototype code base for development purposes.

\subsection{Satisfying Requirements}%
\label{satisfying-requirements}

Mistral offers users a number of software packages via the module
command (man module). While large parts of ESDM will build with the
standard tools available on the platform, it is still recommended to use
Spack \url{https://spack.readthedocs.io/en/latest/index.html} to build,
manage and install dependencies.

\subsection{Download and enable Spack}%
\label{download-and-enable-spack}

\begin{lstlisting}
git clone --depth=2 https://github.com/spack/spack.git spack
. spack/share/spack/setup-env.sh
\end{lstlisting}

\subsection{Set a gcc version to be used}%
\label{set-a-gcc-version-to-be-used}

gccver=7.3.0

\subsection{Install Dependencies}%
\label{install-dependencies}

\begin{lstlisting}
spack install gcc@$gccver +binutils
spack install autoconf%gcc@$gccver
spack install openmpi%gcc@$gccver gettext%gcc@$gccver
spack install jansson%gcc@$gccver glib%gcc@$gccver
\end{lstlisting}

\subsection{Load Dependencies}%
\label{load-dependencies}

\begin{lstlisting}
spack load gcc@$gccver
spack load -r autoconf%gcc@$gccver
spack load -r libtool%gcc@$gccver

spack load -r openmpi%gcc@$gccver
spack load -r jansson%gcc@$gccver
spack load -r glib%gcc@$gccver
\end{lstlisting}

\subsubsection{HDF5 with Virtual Object Layer Support}%
\label{hdf5-with-virtual-object-layer-support}

Assuming all prerequisites have been installed and tested a development
branch of HDF5 can be build as follows.

\subsection{Ensure environment is aware of dependencies installed using spack and dev-env}%
\label{ensure-environment-is-aware-of-dependencies-installed-using-spack-and-dev-env}

\subsection{Download HDF5 with VOL support}%
\label{download-hdf5-with-vol-support}

\begin{lstlisting}
svn checkout https://svn.hdfgroup.org/hdf5/features/vol/
\end{lstlisting}

\subsection{Configure and build HDF5}%
\label{configure-and-build-hdf5}

\begin{lstlisting}
cd vol
./autogen.sh
export CC=mpicc         ### parallel features require mpicc
../configure \
    --prefix=$prefix \
    --enable-parallel \
    --enable-build-mode=debug \
    --enable-hl \
    --enable-shared
make -j
make test
make install
\end{lstlisting}

\subsubsection{NetCDF with Support for ESDM VOL Plugin}%
\label{netcdf-with-support-for-esdm-vol-plugin}

Assuming all prerequisites have been installed and tested a patched
version of NetCDF to enable/disable ESDM VOL Plugin support can be build
as follows.

\subsection{Ensure environment is aware of dependencies installed using spack and dev-env}%
\label{ensure-environment-is-aware-of-dependencies-installed-using-spack-and-dev-env-1}

\subsection{Downlaod NetCDF source}%
\label{downlaod-netcdf-source}

version=4.5.0

\begin{lstlisting}
wget ftp://ftp.unidata.ucar.edu/pub/netcdf/netcdf-$version.tar.gz
cd netcdf-$version
\end{lstlisting}

\subsection{Apply patches to allow enabling/disabling plugin}%
\label{apply-patches-to-allow-enablingdisabling-plugin}

\begin{lstlisting}
patch -b --verbose $PWD/libsrc4/nc4file.c $ESDM_REPO_ROOT/dev/netcdf4-libsrc4-nc4file-c.patch
patch -b --verbose $PWD/include/netcdf.h $ESDM_REPO_ROOT/dev/netcdf4-include-netcdf-h.patch
\end{lstlisting}

\subsection{Configure and build}%
\label{configure-and-build}

\begin{lstlisting}
export CC=mpicc
mkdir build && cd build
cmake \
  -DCMAKE_PREFIX_PATH=$prefix \
  -DCMAKE_INSTALL_PREFIX:PATH=$prefix \
  -DCMAKE_C_FLAGS=-L$prefix/lib/ \
  -DENABLE_PARALLEL4=ON ..
make -j
make test
make install
\end{lstlisting}

\subsubsection{Building ESDM Prototype}%
\label{building-esdm-prototype}

Assuming all prerequisites have been installed and tested ESDM can be
configured and build as follows.

\subsection{Ensure environment is aware of dependencies installed using spack and dev-env}%
\label{ensure-environment-is-aware-of-dependencies-installed-using-spack-and-dev-env-2}

\begin{lstlisting}
cd $ESDM_REPO_ROOT
\end{lstlisting}

\subsection{Configure and build ESDM}%
\label{configure-and-build-esdm}

\begin{lstlisting}
./configure --enable-hdf5 --enable-netcdf4 --debug
cd build
make

make test
\end{lstlisting}
